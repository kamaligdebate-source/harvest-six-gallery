<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholars Gallery | Harvest Six</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåæ</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --harvest-green: #7d8c6b; 
            --dark-olive: #4a4a40;
            --cream-bg: #f2efdf; 
            --card-paper: #fdfcf5;
            --text-main: #5a5a50;
            --wax-seal: #a63d40;
            --banig-pattern: repeating-linear-gradient(45deg, rgba(125, 140, 107, 0.05) 0px, rgba(125, 140, 107, 0.05) 2px, transparent 2px, transparent 4px);
        }

        body { 
            font-family: 'Quicksand', sans-serif; 
            background-color: var(--cream-bg); 
            margin: 0; padding: 0; 
            color: var(--text-main); 
            background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png");
            overflow-x: hidden;
        }

        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        header { 
            padding: 120px 20px 60px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; text-align: center; z-index: 2;
        }
        .header-title { 
            font-family: 'Fredoka', sans-serif; 
            font-size: clamp(3rem, 10vw, 4.8rem); 
            color: var(--dark-olive); margin: 0; font-weight: 700;
        }

        #topHarvesterCycle { margin-top: 25px; min-height: 24px; }
        #leaderName { 
            font-weight: 700; font-size: 11px; color: var(--harvest-green); 
            text-transform: uppercase; letter-spacing: 3px;
            background: rgba(255,255,255,0.5); padding: 8px 20px; border-radius: 50px;
            border: 1px solid rgba(0,0,0,0.05); transition: opacity 1.2s;
        }
        .fade-out { opacity: 0 !important; }

        .population-box { margin-top: 35px; }
        .goal-bar-bg { width: 280px; height: 8px; background: rgba(0,0,0,0.06); border-radius: 20px; margin: 12px auto; overflow: hidden; }
        #goalProgress { background: var(--harvest-green); width: 0%; height: 100%; border-radius: 20px; transition: 2s ease; }
        .counter-text { font-size: 10px; font-weight: 700; color: var(--dark-olive); text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.8; }

        .sticky-controls { 
            position: sticky; top: 0; z-index: 200; 
            background: rgba(242, 239, 223, 0.92); backdrop-filter: blur(10px);
            padding: 20px 0; text-align: center;
            border-bottom: 4px solid var(--harvest-green);
            background-image: var(--banig-pattern);
        }
        .nav-btn { 
            font-family: 'Fredoka', sans-serif; font-size: 10px; text-transform: uppercase; 
            padding: 10px 18px; border: 1px solid var(--dark-olive); border-radius: 2px; 
            cursor: pointer; color: var(--dark-olive); text-decoration: none; font-weight: 700; margin: 0 4px;
            transition: 0.3s; display: inline-block; background: transparent;
        }
        .nav-btn:hover { background: var(--dark-olive); color: var(--cream-bg); }
        
        #scholarSearch { 
            margin-top: 15px; width: 280px; padding: 12px 20px; 
            border: 1px solid rgba(0,0,0,0.1); border-radius: 0;
            font-family: 'Quicksand', sans-serif; outline: none; background: #fdfdfa;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.04);
        }

        /* GARDEN BOX */
        #grainGardenContainer {
            position: fixed; bottom: 30px; left: 30px; z-index: 1000;
            background: var(--card-paper); border: 1px solid #ddd; padding: 15px; width: 140px; text-align: center;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.05); overflow: hidden;
        }
        #gardenCanvas { width: 100%; height: 80px; background: #f4f3e9; margin-bottom: 10px; border-radius: 4px; }

        .cohort-section { padding: 40px 10% 80px; }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 30px; 
            overflow: visible !important; 
        }

        .scholar-card { 
            display: flex; flex-direction: column; background: var(--card-paper); 
            padding: 50px 25px 30px; border-radius: 4px;
            text-align: center; position: relative; opacity: 0; transform: translateY(20px);
            box-shadow: 1px 1px 12px rgba(0,0,0,0.04); transition: transform 0.3s, opacity 0.8s, z-index 0s;
            height: auto;
            min-height: 200px;
            overflow: visible !important; 
            z-index: 5;
        }
        /* Card jumps to front when interacted with to prevent clipping behind neighbor */
        .scholar-card:hover, .scholar-card:focus-within { z-index: 999; transform: translateY(-5px); }
        .scholar-card.sprouted { opacity: 1; transform: translateY(0); }

        .break-badge { 
            position: absolute; top: 15px; left: 15px; font-size: 10px; font-weight: 700; 
            color: #fff; background: var(--harvest-green); padding: 4px 12px; 
            cursor: pointer; z-index: 10; letter-spacing: 1px;
        }

        .harvest-log-container {
            position: absolute; 
            top: 35px; 
            left: 0; 
            width: 300px;
            background: #ffffff; 
            padding: 20px; 
            border: 1px solid #eee;
            text-align: left; 
            z-index: 1000; 
            opacity: 0; 
            visibility: hidden;
            transition: 0.2s ease; 
            pointer-events: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            max-height: 350px;
            overflow-y: auto;
        }

        .break-badge:hover .harvest-log-container,
        .break-badge.is-active .harvest-log-container { 
            opacity: 1; 
            visibility: visible; 
            pointer-events: auto; 
        }

        .log-title { font-family: 'Fredoka', sans-serif; font-size: 10px; text-transform: uppercase; color: var(--harvest-green); border-bottom: 1px solid #eee; padding-bottom: 6px; margin-bottom: 10px; display: block; letter-spacing: 2px; }
        .tournament-list { margin: 0; padding: 0; list-style: none; font-size: 11px; color: #555; line-height: 1.5; }
        .tournament-list li { border-bottom: 1px solid #f8f8f8; padding: 8px 0; display: flex; align-items: flex-start; position: relative; padding-left: 28px; }
        .tournament-list li::before { position: absolute; left: 0; font-size: 12px; top: 8px; }

        .li-kamalig::before { content: "üåæ"; }
        .li-champ::before { content: "üèÜ"; }
        .li-national::before { content: "‚≠ê"; }
        .li-regional::before { content: "üìç"; }

        .name { font-family: 'Fredoka', sans-serif; font-weight: 600; color: var(--dark-olive); font-size: 1.2rem; margin-top: 10px; }
        .inst { font-size: 9px; color: #aaa; text-transform: uppercase; font-weight: 700; margin-bottom: 15px; display: block; letter-spacing: 1.5px; }
        .accolade-box { font-size: 11px; color: #888; margin-top: auto; padding-top: 15px; font-style: italic; border-top: 1px solid #f9f9f9; }

        .ver-stamp { position: fixed; bottom: 5px; right: 10px; font-size: 8px; color: var(--dark-olive); opacity: 0.2; z-index: 9999; }
        footer { text-align: center; padding: 80px 20px; opacity: 0.4; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<header>
    <h1 class="header-title">Harvest Six</h1>
    <div id="topHarvesterCycle"><span id="leaderName">Gathering the Grain...</span></div>
    <div class="population-box">
        <div class="counter-text">Batch Population: <span id="countDisplay">0</span> / 100</div>
        <div class="goal-bar-bg"><div id="goalProgress"></div></div>
    </div>
</header>

<div class="sticky-controls">
    <div id="batchNav"></div>
    <input type="text" id="scholarSearch" placeholder="Search the archives..." onkeyup="debouncedSearch()">
</div>

<div id="grainGardenContainer">
    <canvas id="gardenCanvas"></canvas>
    <div style="font-size: 20px; font-weight: 700; color: var(--dark-olive); font-family: 'Fredoka';" id="totalBreaks">0</div>
    <div style="font-size: 8px; text-transform: uppercase; color: #aaa; letter-spacing: 1px;">Total Yield</div>
</div>

<div id="gallery"></div>
<div class="ver-stamp">H6-C8</div>

<footer>
    <a href="https://forms.gle/EQ8bFb1KJLaew9vX7" target="_blank" style="color: var(--dark-olive); font-family: 'Fredoka'; font-size: 10px; font-weight: 700; text-decoration: none; text-transform: uppercase; letter-spacing: 3px;">Update Scholar Profile</a>
</footer>

<script>
    const bgCanvas = document.getElementById('bgCanvas');
    const bgCtx = bgCanvas.getContext('2d');
    const gardenCanvas = document.getElementById('gardenCanvas');
    const gCtx = gardenCanvas.getContext('2d');
    let chaffArray = [];
    let grainArray = [];

    function initCanvas() {
        bgCanvas.width = window.innerWidth;
        bgCanvas.height = window.innerHeight;
        chaffArray = Array.from({ length: 30 }, () => ({
            x: Math.random() * bgCanvas.width,
            y: Math.random() * bgCanvas.height,
            size: Math.random() * 3 + 1,
            speed: Math.random() * 0.5 + 0.2,
            angle: Math.random() * Math.PI * 2
        }));
    }

    function animate() {
        bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
        bgCtx.fillStyle = 'rgba(255, 255, 255, 0.4)';
        chaffArray.forEach(p => {
            p.y -= p.speed;
            p.x += Math.sin(p.angle) * 0.5;
            p.angle += 0.02;
            if (p.y < -10) p.y = bgCanvas.height + 10;
            bgCtx.beginPath();
            bgCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            bgCtx.fill();
        });

        // GARDEN ANIMATION (Sun and Breezy Rice)
        gCtx.clearRect(0, 0, gardenCanvas.width, gardenCanvas.height);
        
        // Moving Sun
        const sunX = (Date.now() * 0.01) % (gardenCanvas.width + 40) - 20;
        gCtx.font = '20px serif';
        gCtx.fillText('‚òÄÔ∏è', sunX, 25);

        // Breezy Rice Stalks
        gCtx.font = '24px serif';
        grainArray.forEach(g => {
            const sway = Math.sin(Date.now() * 0.002 + g.offset) * 8;
            gCtx.save();
            gCtx.translate(g.x, gardenCanvas.height - 5);
            gCtx.rotate(sway * Math.PI / 180);
            gCtx.fillText('üåæ', -12, 0);
            gCtx.restore();
        });
        requestAnimationFrame(animate);
    }

    function parseFullCSV(data) {
        const result = [];
        let row = ['']; let i = 0; let inQuotes = false;
        for (let j = 0; j < data.length; j++) {
            const char = data[j]; const nextChar = data[j+1];
            if (char === '"' && inQuotes && nextChar === '"') { row[i] += '"'; j++; }
            else if (char === '"') { inQuotes = !inQuotes; }
            else if (char === ',' && !inQuotes) { row[++i] = ''; }
            else if ((char === '\n' || char === '\r') && !inQuotes) {
                if (row.length > 1 || row[0] !== '') result.push(row);
                row = ['']; i = 0; if (char === '\r' && nextChar === '\n') j++;
            } else { row[i] += char; }
        }
        if (row.length > 1 || row[0] !== '') result.push(row);
        return result;
    }

    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTHPJe3Zt0F1OO2gt1igtfKLmt4QdMedmq7qI3wn769I-lpWA0aMZ9I07v1DwJgdCuDz2i3t2wPyfmt/pub?output=csv';
    let allData = [];
    let leaders = [];
    let lIdx = 0;

    async function loadGallery() {
        try {
            const res = await fetch(sheetUrl);
            const rawCsv = await res.text();
            const allRows = parseFullCSV(rawCsv.trim()).slice(1);
            allData = allRows.map(c => {
                if (!c[0] || c[0].trim() === "") return null;
                return { 
                    name: c[0].trim(), batchNum: c[1].trim(), accolade: c[2].trim(), 
                    batchName: c[3].trim(), institution: c[5].trim(), 
                    breaks: parseInt(c[6]) || 0, tournaments: c[7] ? c[7].trim() : "" 
                };
            }).filter(i => i !== null);
            render();
            document.body.addEventListener('click', () => document.querySelectorAll('.break-badge').forEach(b => b.classList.remove('is-active')));
        } catch (e) { console.error("Data Load Error:", e); }
    }

    function render() {
        const gal = document.getElementById('gallery');
        const nav = document.getElementById('batchNav');
        gal.innerHTML = ""; nav.innerHTML = "";

        const totalBreaks = allData.reduce((s, i) => s + i.breaks, 0);
        document.getElementById('totalBreaks').innerText = totalBreaks;
        document.getElementById('countDisplay').innerText = allData.length;
        document.getElementById('goalProgress').style.width = Math.min(allData.length, 100) + "%";

        // Garden density
        grainArray = Array.from({ length: Math.min(Math.floor(totalBreaks / 4), 12) }, () => ({
            x: Math.random() * (gardenCanvas.width - 20) + 10,
            offset: Math.random() * 100
        }));

        const batches = [...new Set(allData.map(i => i.batchNum))].sort((a,b) => a-b);
        batches.forEach(bNum => {
            const bItems = allData.filter(i => i.batchNum === bNum);
            const bName = bItems[0].batchName || `Batch ${bNum}`;
            const bID = `batch-${bNum}`;
            nav.innerHTML += `<a href="#${bID}" class="nav-btn">${bName}</a>`;
            const section = document.createElement('div');
            section.className = 'cohort-section'; section.id = bID;
            section.innerHTML = `<div style="font-family:'Fredoka'; font-size:16px; color:var(--dark-olive); letter-spacing:5px; margin-bottom:30px; text-align:center;">‚Äî ${bName} ‚Äî</div><div class="grid"></div>`;
            const grid = section.querySelector('.grid');
            
            bItems.forEach((item) => {
                let tourneyItems = "";
                if (item.tournaments) {
                    const rawList = item.tournaments.split(/\r?\n|,/).filter(t => t.trim() !== "");
                    tourneyItems = rawList.map(t => {
                        const raw = t.trim();
                        let pClass = "";
                        if (raw.startsWith('||')) pClass = "li-kamalig";
                        else if (raw.startsWith('***')) pClass = "li-champ";
                        else if (raw.startsWith('**')) pClass = "li-national";
                        else if (raw.startsWith('*')) pClass = "li-regional";
                        
                        const clean = raw.replace(/(\|\||\*\*\*|\*\*|\*)/g, '');
                        return `<li class="${pClass}">${clean}</li>`;
                    }).join('');
                }

                grid.innerHTML += `
                    <div class="scholar-card">
                        ${item.breaks > 0 ? `<div class="break-badge" onmouseenter="fixLayout(this)" onclick="event.stopPropagation(); this.classList.toggle('is-active'); fixLayout(this);">${item.breaks} Breaks 
                            <div class="harvest-log-container"><span class="log-title">Harvest Log</span><ul class="tournament-list">${tourneyItems}</ul></div>
                        </div>` : ''}
                        <div style="font-size:28px; margin-bottom:10px; opacity:0.8;">${item.breaks > 0 ? 'üåæ' : 'üå±'}</div>
                        <span class="name">${item.name}</span>
                        <span class="inst">${item.institution}</span>
                        <div class="accolade-box">${item.accolade}</div>
                    </div>`;
            });
            gal.appendChild(section);
        });

        const obs = new IntersectionObserver((es) => es.forEach(e => { if(e.isIntersecting) e.target.classList.add('sprouted') }), {threshold:0.1});
        document.querySelectorAll('.scholar-card').forEach(c => obs.observe(c));
        
        leaders = allData.filter(s => s.breaks === Math.max(...allData.map(x => x.breaks)) && s.breaks > 0);
        if(leaders.length) startLeaderCycle();
    }

    function fixLayout(badge) {
        const log = badge.querySelector('.harvest-log-container');
        if(!log) return;
        
        log.style.left = "0"; log.style.right = "auto";
        log.style.top = "35px"; log.style.bottom = "auto";

        const rect = log.getBoundingClientRect();
        if (rect.right > window.innerWidth) { log.style.left = "auto"; log.style.right = "0"; }
        if (rect.bottom > window.innerHeight) { log.style.top = "auto"; log.style.bottom = "100%"; }
    }

    let searchTimer;
    function debouncedSearch() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
            const t = document.getElementById('scholarSearch').value.toLowerCase();
            document.querySelectorAll('.scholar-card').forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(t) ? 'flex' : 'none';
            });
        }, 300);
    }

    function startLeaderCycle() {
        const el = document.getElementById('leaderName');
        setInterval(() => {
            el.classList.add('fade-out');
            setTimeout(() => {
                lIdx = (lIdx + 1) % leaders.length;
                el.innerText = `Top Harvest: ${leaders[lIdx].name}`;
                el.classList.remove('fade-out');
            }, 1200); 
        }, 5500);
    }

    window.addEventListener('resize', initCanvas);
    initCanvas();
    animate();
    loadGallery();
</script>
</body>
</html>
