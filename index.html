<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholars Gallery | Harvest Six</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒ¾</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Sun-Bleached Palette */
            --harvest-green: #7d8c6b; 
            --dark-olive: #4a4a40;
            --cream-bg: #f2efdf; 
            --card-paper: #fdfcf5;
            --text-main: #5a5a50;
            --wax-seal: #a63d40;
            --banig-pattern: repeating-linear-gradient(45deg, rgba(125, 140, 107, 0.05) 0px, rgba(125, 140, 107, 0.05) 2px, transparent 2px, transparent 4px);
        }

        body { 
            font-family: 'Quicksand', sans-serif; 
            background-color: var(--cream-bg); 
            margin: 0; padding: 0; 
            color: var(--text-main); 
            background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png");
            overflow-x: hidden;
        }

        /* --- FLOATING CHAFF PARTICLES --- */
        #chaff-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 600px;
            pointer-events: none; z-index: 1; overflow: hidden;
        }
        .chaff {
            position: absolute; background: rgba(255, 255, 255, 0.5);
            border-radius: 50%; pointer-events: none;
            animation: drift linear infinite;
        }
        @keyframes drift {
            from { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.7; }
            90% { opacity: 0.7; }
            to { transform: translateY(-600px) translateX(120px) rotate(360deg); opacity: 0; }
        }

        /* --- HEADER --- */
        header { 
            padding: 120px 20px 60px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; text-align: center; z-index: 2;
        }
        .header-title { 
            font-family: 'Fredoka', sans-serif; 
            font-size: clamp(3rem, 10vw, 4.8rem); 
            color: var(--dark-olive); margin: 0; font-weight: 700;
            letter-spacing: -1px;
        }

        #topHarvesterCycle { margin-top: 25px; min-height: 24px; }
        #leaderName { 
            font-weight: 700; font-size: 11px; color: var(--harvest-green); 
            text-transform: uppercase; letter-spacing: 3px;
            background: rgba(255,255,255,0.5); padding: 8px 20px; border-radius: 50px;
            border: 1px solid rgba(0,0,0,0.05); transition: opacity 1.2s;
        }
        .fade-out { opacity: 0 !important; }

        /* --- POPULATION COUNTER --- */
        .population-box { margin-top: 35px; }
        .goal-bar-bg { width: 280px; height: 8px; background: rgba(0,0,0,0.06); border-radius: 20px; margin: 12px auto; overflow: hidden; }
        #goalProgress { background: var(--harvest-green); width: 0%; height: 100%; border-radius: 20px; transition: 2s ease; }
        .counter-text { font-size: 10px; font-weight: 700; color: var(--dark-olive); text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.8; }

        /* --- BANIG STICKY NAV --- */
        .sticky-controls { 
            position: sticky; top: 0; z-index: 200; 
            background: rgba(242, 239, 223, 0.9); backdrop-filter: blur(10px);
            padding: 20px 0; text-align: center;
            border-bottom: 4px solid var(--harvest-green);
            background-image: var(--banig-pattern);
        }
        .nav-btn { 
            font-family: 'Fredoka', sans-serif; font-size: 10px; text-transform: uppercase; 
            padding: 10px 18px; border: 1px solid var(--dark-olive); border-radius: 2px; 
            cursor: pointer; color: var(--dark-olive); text-decoration: none; font-weight: 700; margin: 0 4px;
            transition: 0.3s; display: inline-block; background: transparent;
        }
        .nav-btn:hover { background: var(--dark-olive); color: var(--cream-bg); }
        
        #scholarSearch { 
            margin-top: 15px; width: 280px; padding: 12px 20px; 
            border: 1px solid rgba(0,0,0,0.1); border-radius: 0;
            font-family: 'Quicksand', sans-serif; outline: none; background: #fdfdfa;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.04);
        }

        /* --- GARDEN --- */
        #grainGardenContainer {
            position: fixed; bottom: 30px; left: 30px; z-index: 1000;
            background: var(--card-paper); border: 1px solid #ddd; padding: 15px; width: 120px; text-align: center;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.05);
        }
        #gardenBed { height: 60px; position: relative; overflow: hidden; background: #f4f3e9; margin-bottom: 10px; }
        .garden-item { position: absolute; bottom: 0; animation: sway 3s ease-in-out infinite alternate; transform-origin: bottom; }
        @keyframes sway { from { transform: rotate(-5deg); } to { transform: rotate(5deg); } }

        /* --- CARDS WITH LEAF DECALS --- */
        .cohort-section { padding: 60px 10% 40px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 35px; }

        .scholar-card { 
            display: flex; flex-direction: column; background: var(--card-paper); 
            padding: 60px 30px 40px; border-radius: 4px;
            text-align: center; position: relative; opacity: 0; transform: translateY(20px);
            box-shadow: 1px 1px 12px rgba(0,0,0,0.04); transition: 0.8s cubic-bezier(0.2, 1, 0.3, 1);
            height: 100%; box-sizing: border-box; overflow: hidden;
        }
        /* Leaf Decal */
        .scholar-card::after {
            content: ""; position: absolute; bottom: -15px; right: -15px;
            width: 120px; height: 120px; opacity: 0.04; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 10 Q60 40 90 50 Q60 60 50 90 Q40 60 10 50 Q40 40 50 10' fill='%234a4a40'/%3E%3C/svg%3E");
            background-size: contain; background-repeat: no-repeat;
        }
        .scholar-card.sprouted { opacity: 1; transform: translateY(0); }

        .break-badge { 
            position: absolute; top: 20px; left: 20px; font-size: 10px; font-weight: 700; 
            color: #fff; background: var(--harvest-green); padding: 5px 14px; 
            cursor: pointer; z-index: 20; letter-spacing: 1px;
        }

        /* WAX SEAL */
        .wax-seal {
            display: inline-block; width: 18px; height: 18px;
            background: var(--wax-seal); border-radius: 50%;
            margin-right: 10px; vertical-align: middle;
            box-shadow: inset -1px -1px 3px rgba(0,0,0,0.4), 1px 1px 1px rgba(0,0,0,0.2);
            position: relative;
        }
        .wax-seal::after {
            content: "ðŸŒ¾"; font-size: 9px; color: rgba(255,255,255,0.4);
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }

        .harvest-log-container {
            position: absolute; top: 40px; left: 0; width: 240px;
            background: #fff; padding: 18px; border: 1px solid #ddd;
            text-align: left; z-index: 100; opacity: 0; visibility: hidden;
            transition: 0.3s ease; pointer-events: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .break-badge:hover .harvest-log-container,
        .break-badge.is-active .harvest-log-container { opacity: 1; visibility: visible; pointer-events: auto; }

        .log-title { font-family: 'Fredoka', sans-serif; font-size: 10px; text-transform: uppercase; color: var(--harvest-green); border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; display: block; letter-spacing: 2px; }
        .tournament-list { margin: 0; padding: 0; list-style: none; font-size: 10.5px; color: #777; line-height: 1.8; }
        .tournament-list li { border-bottom: 1px solid #f9f9f9; padding: 4px 0; display: flex; align-items: center; }
        
        .name { font-family: 'Fredoka', sans-serif; font-weight: 600; color: var(--dark-olive); font-size: 1.25rem; margin-top: 5px; }
        .inst { font-size: 9px; color: #aaa; text-transform: uppercase; font-weight: 700; margin-bottom: 20px; display: block; letter-spacing: 1.5px; }
        .accolade-box { font-size: 11px; color: #888; margin-top: auto; padding-top: 15px; font-style: italic; border-top: 1px solid #f9f9f9; }

        footer { text-align: center; padding: 100px 20px; opacity: 0.4; }
    </style>
</head>
<body>

<div id="chaff-container"></div>

<header>
    <h1 class="header-title">Harvest Six</h1>
    <div id="topHarvesterCycle"><span id="leaderName">Gathering the Grain...</span></div>
    
    <div class="population-box">
        <div class="counter-text">Batch Population: <span id="countDisplay">0</span> / 100</div>
        <div class="goal-bar-bg"><div id="goalProgress"></div></div>
    </div>
</header>

<div class="sticky-controls">
    <div id="batchNav"></div>
    <input type="text" id="scholarSearch" placeholder="Search the archives..." onkeyup="searchScholars()">
</div>

<div id="grainGardenContainer">
    <div id="gardenBed"></div>
    <div style="font-size: 20px; font-weight: 700; color: var(--dark-olive); font-family: 'Fredoka';" id="totalBreaks">0</div>
    <div style="font-size: 8px; text-transform: uppercase; color: #aaa; letter-spacing: 1px;">Total Yield</div>
</div>

<div id="gallery"></div>

<footer>
    <a href="https://forms.gle/EQ8bFb1KJLaew9vX7" target="_blank" style="color: var(--dark-olive); font-family: 'Fredoka'; font-size: 10px; font-weight: 700; text-decoration: none; text-transform: uppercase; letter-spacing: 3px;">Update Scholar Profile</a>
</footer>

<script>
    // 1. CHAFF GENERATOR
    function createChaff() {
        const container = document.getElementById('chaff-container');
        for (let i = 0; i < 25; i++) {
            const chaff = document.createElement('div');
            chaff.className = 'chaff';
            const size = Math.random() * 3 + 2;
            chaff.style.width = size + 'px';
            chaff.style.height = size + 'px';
            chaff.style.left = Math.random() * 100 + '%';
            chaff.style.top = Math.random() * 100 + '%';
            chaff.style.animationDuration = (Math.random() * 8 + 10) + 's';
            chaff.style.animationDelay = (Math.random() * 5) + 's';
            container.appendChild(chaff);
        }
    }

    // 2. ROBUST CSV PARSER
    function parseFullCSV(data) {
        const result = [];
        let row = ['']; let i = 0; let inQuotes = false;
        for (let j = 0; j < data.length; j++) {
            const char = data[j]; const nextChar = data[j+1];
            if (char === '"' && inQuotes && nextChar === '"') { row[i] += '"'; j++; }
            else if (char === '"') { inQuotes = !inQuotes; }
            else if (char === ',' && !inQuotes) { row[++i] = ''; }
            else if ((char === '\n' || char === '\r') && !inQuotes) {
                if (row.length > 1 || row[0] !== '') result.push(row);
                row = ['']; i = 0; if (char === '\r' && nextChar === '\n') j++;
            } else { row[i] += char; }
        }
        if (row.length > 1 || row[0] !== '') result.push(row);
        return result;
    }

    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTHPJe3Zt0F1OO2gt1igtfKLmt4QdMedmq7qI3wn769I-lpWA0aMZ9I07v1DwJgdCuDz2i3t2wPyfmt/pub?output=csv';
    let allData = [];
    let leaders = [];
    let lIdx = 0;

    async function loadGallery() {
        try {
            const res = await fetch(sheetUrl);
            const rawCsv = await res.text();
            const allRows = parseFullCSV(rawCsv.trim()).slice(1);
            allData = allRows.map(c => {
                if (!c[0] || c[0].trim() === "") return null;
                return { 
                    name: c[0].trim(), batchNum: c[1].trim(), accolade: c[2].trim(), 
                    batchName: c[3].trim(), institution: c[5].trim(), 
                    breaks: parseInt(c[6]) || 0, tournaments: c[7] ? c[7].trim() : "" 
                };
            }).filter(i => i !== null);
            render();
            document.body.addEventListener('click', () => document.querySelectorAll('.break-badge').forEach(b => b.classList.remove('is-active')));
        } catch (e) { console.error("Data Load Error:", e); }
    }

    function render() {
        const gal = document.getElementById('gallery');
        const nav = document.getElementById('batchNav');
        const bed = document.getElementById('gardenBed');
        gal.innerHTML = ""; nav.innerHTML = ""; bed.innerHTML = "";

        document.getElementById('countDisplay').innerText = allData.length;
        document.getElementById('goalProgress').style.width = Math.min(allData.length, 100) + "%";
        const totalBreaks = allData.reduce((s, i) => s + i.breaks, 0);
        document.getElementById('totalBreaks').innerText = totalBreaks;

        for(let i=0; i < Math.floor(totalBreaks / 5); i++) {
            const g = document.createElement('span'); g.className = 'garden-item'; g.innerHTML = 'ðŸŒ¾';
            g.style.left = Math.random() * 85 + "%"; g.style.fontSize = (15 + Math.random() * 10) + "px";
            bed.appendChild(g);
        }

        const batches = [...new Set(allData.map(i => i.batchNum))].sort((a,b) => a-b);
        batches.forEach(bNum => {
            const bItems = allData.filter(i => i.batchNum === bNum);
            const bName = bItems[0].batchName || `Batch ${bNum}`;
            const bID = `batch-${bNum}`;
            nav.innerHTML += `<a href="#${bID}" class="nav-btn">${bName}</a>`;
            const section = document.createElement('div');
            section.className = 'cohort-section'; section.id = bID;
            section.innerHTML = `<div style="font-family:'Fredoka'; font-size:16px; color:var(--dark-olive); letter-spacing:5px; margin-bottom:40px; text-align:center;">â€” ${bName} â€”</div><div class="grid"></div>`;
            const grid = section.querySelector('.grid');
            
            bItems.forEach((item) => {
                let tourneyItems = "";
                if (item.tournaments) {
                    const rawList = item.tournaments.split(/\r?\n|,/).filter(t => t.trim() !== "");
                    tourneyItems = rawList.map(t => {
                        const raw = t.trim(); const isGold = raw.startsWith('*') && raw.endsWith('*');
                        return `<li>${isGold ? '<span class="wax-seal"></span>' : ''}${raw.replace(/\*/g, '')}</li>`;
                    }).join('');
                }

                grid.innerHTML += `
                    <div class="scholar-card">
                        ${item.breaks > 0 ? `<div class="break-badge" onclick="event.stopPropagation(); this.classList.toggle('is-active');">${item.breaks} Breaks 
                            <div class="harvest-log-container"><span class="log-title">Harvest Log</span><ul class="tournament-list">${tourneyItems}</ul></div>
                        </div>` : ''}
                        <div style="font-size:32px; margin-bottom:15px; opacity:0.8;">${item.breaks > 0 ? 'ðŸŒ¾' : 'ðŸŒ±'}</div>
                        <span class="name">${item.name}</span>
                        <span class="inst">${item.institution}</span>
                        <div class="accolade-box">${item.accolade}</div>
                    </div>`;
            });
            gal.appendChild(section);
        });

        setTimeout(() => {
            const obs = new IntersectionObserver((es) => es.forEach(e => { if(e.isIntersecting) e.target.classList.add('sprouted') }), {threshold:0.1});
            document.querySelectorAll('.scholar-card').forEach(c => obs.observe(c));
        }, 100);
        const maxB = Math.max(...allData.map(x => x.breaks));
        leaders = allData.filter(s => s.breaks === maxB && maxB > 0);
        if(leaders.length) startLeaderCycle();
    }

    function startLeaderCycle() {
        const el = document.getElementById('leaderName');
        const cycle = () => {
            el.classList.add('fade-out');
            setTimeout(() => {
                lIdx = (lIdx + 1) % leaders.length;
                el.innerText = `Top Harvest: ${leaders[lIdx].name}`;
                el.classList.remove('fade-out');
            }, 1200); 
        };
        setInterval(cycle, 5500);
        el.innerText = `Top Harvest: ${leaders[0].name}`;
    }

    function searchScholars() {
        const searchT = document.getElementById('scholarSearch').value.toLowerCase();
        document.querySelectorAll('.scholar-card').forEach(c => {
            const text = c.innerText.toLowerCase();
            c.style.display = text.includes(searchT) ? 'flex' : 'none';
        });
        document.querySelectorAll('.cohort-section').forEach(section => {
            const hasVisible = Array.from(section.querySelectorAll('.scholar-card')).some(card => card.style.display !== 'none');
            section.style.display = hasVisible ? 'block' : 'none';
        });
    }

    createChaff();
    loadGallery();
</script>
</body>
</html>
